<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tag Manager - AIç»˜å›¾æ ‡ç­¾ç®¡ç†å™¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">ğŸ¨</span>
                <h1>AI Tag Manager</h1>
            </div>
            <p class="subtitle">AIç»˜å›¾æ ‡ç­¾ç®¡ç†å™¨</p>
            <div class="header-nav">
                <button class="btn btn-nav btn-settings" onclick="openSettingsModal()" title="è®¾ç½®">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
                <a href="/gallery" class="btn btn-nav">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    ä½œå“ç”»å»Š
                </a>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Left Panel - Tag Library -->
            <section class="panel tag-library">
                <div class="panel-header">
                    <h2>æ ‡ç­¾åº“ / Tag Library</h2>
                    <div class="panel-header-actions">
                        <button class="btn btn-secondary btn-import" onclick="openImportModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            ä¸€é”®å¯¼å…¥
                        </button>
                        <button class="btn btn-primary btn-add-tag" onclick="openAddTagModal()">
                            <span>+</span> æ·»åŠ æ ‡ç­¾
                        </button>
                    </div>
                </div>

                <!-- Category Filter -->
                <div class="category-filter">
                    <button class="category-btn active" data-category="all">å…¨éƒ¨ All</button>
                </div>

                <!-- Tags Grid -->
                <div class="tags-container" id="tagsContainer">
                    <!-- Tags will be loaded here -->
                </div>
            </section>

            <!-- Right Panel - Selected Tags & Prompt -->
            <section class="panel prompt-panel">
                <div class="panel-header">
                    <h2>å·²é€‰æ ‡ç­¾ / Selected Tags</h2>
                    <button class="btn btn-secondary" onclick="clearSelected()">æ¸…ç©º</button>
                </div>

                <!-- Selected Tags -->
                <div class="selected-tags" id="selectedTags">
                    <p class="empty-hint">ç‚¹å‡»å·¦ä¾§æ ‡ç­¾æ·»åŠ åˆ°è¿™é‡Œ</p>
                </div>

                <!-- Prompt Output -->
                <div class="prompt-section">
                    <div class="prompt-header">
                        <h3>ç”Ÿæˆçš„ Prompt</h3>
                        <div class="prompt-actions">
                            <button class="btn btn-icon" onclick="copyPrompt()" title="å¤åˆ¶">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="prompt-output" id="promptOutput">
                        <span class="placeholder">é€‰æ‹©æ ‡ç­¾åç”Ÿæˆ Prompt...</span>
                    </div>
                </div>

                <!-- Weight Syntax Options -->
                <div class="options-section">
                    <h4>æƒé‡æ ¼å¼ / Weight Format</h4>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="weightFormat" value="sd" checked>
                            <span>SDæ ¼å¼ (tag:1.2)</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="weightFormat" value="nai">
                            <span>NAIæ ¼å¼ {tag}</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="weightFormat" value="plain">
                            <span>çº¯æ–‡æœ¬</span>
                        </label>
                    </div>
                </div>
            </section>
        </main>

        <!-- Category Management -->
        <section class="panel category-panel">
            <div class="panel-header">
                <h2>åˆ†ç±»ç®¡ç† / Category Management</h2>
                <button class="btn btn-primary" onclick="openAddCategoryModal()">
                    <span>+</span> æ·»åŠ åˆ†ç±»
                </button>
            </div>
            <div class="categories-list" id="categoriesList">
                <!-- Categories will be loaded here -->
            </div>
        </section>
    </div>

    <!-- Add Tag Modal -->
    <div class="modal" id="addTagModal">
        <div class="modal-overlay" onclick="closeModal('addTagModal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ æ–°æ ‡ç­¾ / Add New Tag</h3>
                <button class="btn-close" onclick="closeModal('addTagModal')">&times;</button>
            </div>
            <form id="addTagForm" onsubmit="submitAddTag(event)">
                <div class="form-group">
                    <label>è‹±æ–‡åç§° / English Name</label>
                    <input type="text" name="name_en" required placeholder="e.g., masterpiece">
                </div>
                <div class="form-group">
                    <label>ä¸­æ–‡åç§° / Chinese Name</label>
                    <input type="text" name="name_zh" required placeholder="ä¾‹å¦‚ï¼šæ°ä½œ">
                </div>
                <div class="form-group">
                    <label>åˆ†ç±» / Category</label>
                    <div id="categoryDisplay" class="category-display" style="display: none;"></div>
                    <div id="categorySelectGroup">
                        <select name="category_id" id="tagCategorySelect" required>
                            <!-- Options loaded dynamically -->
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>æƒé‡ / Weight (0.1 - 2.0)</label>
                    <input type="number" name="weight" value="1.0" min="0.1" max="2.0" step="0.1">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addTagModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal" id="addCategoryModal">
        <div class="modal-overlay" onclick="closeModal('addCategoryModal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ æ–°åˆ†ç±» / Add New Category</h3>
                <button class="btn-close" onclick="closeModal('addCategoryModal')">&times;</button>
            </div>
            <form id="addCategoryForm" onsubmit="submitAddCategory(event)">
                <div class="form-group">
                    <label>è‹±æ–‡åç§° / English Name</label>
                    <input type="text" name="name_en" required placeholder="e.g., Quality">
                </div>
                <div class="form-group">
                    <label>ä¸­æ–‡åç§° / Chinese Name</label>
                    <input type="text" name="name_zh" required placeholder="ä¾‹å¦‚ï¼šè´¨é‡">
                </div>
                <div class="form-group">
                    <label>é¢œè‰² / Color</label>
                    <input type="color" name="color" value="#6366f1">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addCategoryModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div class="modal" id="editCategoryModal">
        <div class="modal-overlay" onclick="closeModal('editCategoryModal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘åˆ†ç±» / Edit Category</h3>
                <button class="btn-close" onclick="closeModal('editCategoryModal')">&times;</button>
            </div>
            <form id="editCategoryForm" onsubmit="submitEditCategory(event)">
                <input type="hidden" name="id" id="editCategoryId">
                <div class="form-group">
                    <label>è‹±æ–‡åç§° / English Name</label>
                    <input type="text" name="name_en" id="editCategoryNameEn" required>
                </div>
                <div class="form-group">
                    <label>ä¸­æ–‡åç§° / Chinese Name</label>
                    <input type="text" name="name_zh" id="editCategoryNameZh" required>
                </div>
                <div class="form-group">
                    <label>é¢œè‰² / Color</label>
                    <input type="color" name="color" id="editCategoryColor">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="deleteCurrentCategory()">åˆ é™¤</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editCategoryModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Tag Modal -->
    <div class="modal" id="editTagModal">
        <div class="modal-overlay" onclick="closeModal('editTagModal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘æ ‡ç­¾ / Edit Tag</h3>
                <button class="btn-close" onclick="closeModal('editTagModal')">&times;</button>
            </div>
            <form id="editTagForm" onsubmit="submitEditTag(event)">
                <input type="hidden" name="id" id="editTagId">
                <div class="form-group">
                    <label>è‹±æ–‡åç§° / English Name</label>
                    <input type="text" name="name_en" id="editNameEn" required>
                </div>
                <div class="form-group">
                    <label>ä¸­æ–‡åç§° / Chinese Name</label>
                    <input type="text" name="name_zh" id="editNameZh" required>
                </div>
                <div class="form-group">
                    <label>åˆ†ç±» / Category</label>
                    <select name="category_id" id="editTagCategorySelect" required>
                    </select>
                </div>
                <div class="form-group">
                    <label>æƒé‡ / Weight</label>
                    <input type="number" name="weight" id="editWeight" min="0.1" max="2.0" step="0.1">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="deleteCurrentTag()">åˆ é™¤</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editTagModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Tags Modal -->
    <div class="modal" id="importTagsModal">
        <div class="modal-overlay" onclick="closeModal('importTagsModal')"></div>
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>ä¸€é”®å¯¼å…¥æ ‡ç­¾ / Batch Import Tags</h3>
                <button class="btn-close" onclick="closeModal('importTagsModal')">&times;</button>
            </div>
            <div class="import-container">
                <!-- Step 1: Input -->
                <div id="importStep1" class="import-step">
                    <div class="form-group">
                        <label>ç²˜è´´æ ‡ç­¾ / Paste Tags</label>
                        <p class="form-hint">æ”¯æŒé€—å·ã€æ¢è¡Œåˆ†éš”ï¼Œè‡ªåŠ¨è§£æ SD/NAI æ ¼å¼çš„æƒé‡è¯­æ³•</p>
                        <textarea id="importInput" rows="6" placeholder="masterpiece, best quality, 1girl, long hair, blue eyes&#10;æˆ–è€…&#10;(masterpiece:1.2), {best quality}, anime style"></textarea>
                    </div>
                    <div class="form-group">
                        <label>é»˜è®¤åˆ†ç±» / Default Category</label>
                        <select id="importDefaultCategory">
                            <!-- Options loaded dynamically -->
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('importTagsModal')">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" onclick="parseImportTags()" id="parseBtn">
                            <span class="btn-text">è§£æå¹¶ç¿»è¯‘</span>
                            <span class="btn-loading" style="display:none;">å¤„ç†ä¸­...</span>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Preview and Edit -->
                <div id="importStep2" class="import-step" style="display:none;">
                    <div class="import-summary">
                        <span id="importSummary">å…±è§£æ 0 ä¸ªæ ‡ç­¾ï¼Œå…¶ä¸­ 0 ä¸ªä¸ºæ–°æ ‡ç­¾</span>
                    </div>
                    <div class="import-preview-container">
                        <div class="import-preview-header">
                            <span class="preview-col">æ ‡ç­¾ Tag</span>
                            <span class="preview-col">ç¿»è¯‘ Translation</span>
                            <span class="preview-col">åˆ†ç±» Category</span>
                            <span class="preview-col">æ“ä½œ</span>
                        </div>
                        <div class="import-preview-list" id="importPreviewList">
                            <!-- Preview items will be rendered here -->
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="backToImportStep1()">è¿”å›ä¿®æ”¹</button>
                        <button type="button" class="btn btn-primary" onclick="confirmImport()" id="importBtn">
                            <span class="btn-text">ç¡®è®¤å¯¼å…¥</span>
                            <span class="btn-loading" style="display:none;">å¯¼å…¥ä¸­...</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-overlay" onclick="closeModal('settingsModal')"></div>
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>è®¾ç½® / Settings</h3>
                <button class="btn-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <form id="settingsForm" onsubmit="submitSettings(event)">
                <div class="form-body">
                    <div class="settings-section">
                        <h4 class="settings-section-title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            å¤§æ¨¡å‹æœåŠ¡ / LLM Service
                        </h4>
                        <p class="settings-hint">é…ç½®åå°†ä¼˜å…ˆä½¿ç”¨å¤§æ¨¡å‹è¿›è¡Œç¿»è¯‘å’Œåˆ†ç±»åŒ¹é…ï¼Œè·å¾—æ›´å‡†ç¡®çš„ç»“æœ</p>

                        <div class="form-group">
                            <label class="toggle-label">
                                <input type="checkbox" id="llmEnabled" name="llm_enabled">
                                <span class="toggle-switch"></span>
                                <span class="toggle-text">å¯ç”¨å¤§æ¨¡å‹æœåŠ¡</span>
                            </label>
                        </div>

                        <div id="llmSettings" class="llm-settings">
                            <div class="form-group">
                                <label>API åœ°å€ / Base URL</label>
                                <input type="text" id="llmBaseUrl" name="base_url"
                                       placeholder="https://api.openai.com/v1">
                                <p class="form-hint">æ”¯æŒ OpenAI å…¼å®¹æ ¼å¼çš„ APIï¼ˆå¦‚ Azure OpenAIã€æœ¬åœ° Ollama ç­‰ï¼‰</p>
                            </div>

                            <div class="form-group">
                                <label>API å¯†é’¥ / API Key</label>
                                <div class="input-with-action">
                                    <input type="password" id="llmApiKey" name="api_key"
                                           placeholder="sk-...">
                                    <button type="button" class="btn btn-icon" onclick="toggleApiKeyVisibility()" title="æ˜¾ç¤º/éšè—">
                                        <svg id="apiKeyEyeIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                    </button>
                                </div>
                                <p class="form-hint" id="apiKeyStatus"></p>
                            </div>

                            <div class="form-group">
                                <label>æ¨¡å‹åç§° / Model</label>
                                <input type="text" id="llmModel" name="model"
                                       placeholder="gpt-3.5-turbo">
                                <p class="form-hint">å¦‚ gpt-3.5-turbo, gpt-4, claude-3-haiku ç­‰</p>
                            </div>

                            <div class="form-group">
                                <button type="button" class="btn btn-secondary" onclick="testLLMConnection()" id="testLLMBtn">
                                    <span class="btn-text">æµ‹è¯•è¿æ¥</span>
                                    <span class="btn-loading" style="display:none;">æµ‹è¯•ä¸­...</span>
                                </button>
                                <span id="testResult" class="test-result"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('settingsModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜è®¾ç½®</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
